"use strict";const e=require("../common/vendor.js"),s=require("../config/index.js"),o=require("../enums/requestEnum.js"),r=require("../stores/user.js"),t=require("./useToast.js");function u(u){u&&"/"!==u.url[0]&&(u.url=`/${u.url}`);const n=r.useUserStore();return new Promise(((r,i)=>{e.index.request({...u,header:{token:n.token,version:s.config.version},url:`${s.config.baseUrl}${s.config.urlPrefix}${null==u?void 0:u.url}`,success:e=>{const s=e.data,u={[o.RequestCodeEnum.SUCCESS]:()=>{1===s.show&&t.useToast().success(s.msg),r(s.data)},[o.RequestCodeEnum.FAIL]:()=>{1===s.show&&t.useToast(s.msg,{duration:2e3}),i(s.msg)},[o.RequestCodeEnum.LOGIN_FAILURE]:()=>{t.useToast(s.msg),a(),i(s.msg)},[o.RequestCodeEnum.NOT_INSTALL]:()=>{t.useToast().error("系统未安装"),i(new Error("系统未安装"))},[o.RequestCodeEnum.OPEN_NEW_PAGE]:()=>{t.useToast().error("无法跳转新页面"),i(new Error("无法跳转新页面"))},[o.RequestCodeEnum.FORBIDDEN]:()=>{t.useToast().error("无访问权限"),i(new Error("无访问权限"))},[o.RequestCodeEnum.NOT_FOUND]:()=>{t.useToast().error("租户不存在"),i(new Error("租户不存在"))}}[s.code];u?u():i(s.msg),n.refreshToken(),r(s.data)},fail:e=>{console.error(e),t.useToast(e.errMsg,{duration:2e3}),i(e)},complete:()=>{}})}))}const a=e.throttle((async()=>{r.useUserStore().logout()}),1e3);exports.useDownloadFile=s=>{const{type:o,fileUrl:r,success:u,fail:a,complete:n}=s;return""===r?(a("视频路径为空"),t.useToast().error("视频路径为空")):e.index.downloadFile({url:r,success:s=>{if(200===s.statusCode){(0,{image:()=>{e.index.saveImageToPhotosAlbum({filePath:s.tempFilePath,success:e=>{t.useToast().success("已保存到相册"),u(e)},fail:e=>{"saveImageToPhotosAlbum:fail invalid file type"===e.errMsg?t.useToast().error("下载格式错误"):t.useToast().error("保存照片失败"),a(`保存照片失败${e.errMsg}`)}})},video:()=>{e.index.saveVideoToPhotosAlbum({filePath:s.tempFilePath,success:e=>{t.useToast().success("已保存到相册"),u(e)},fail:e=>{"saveImageToPhotosAlbum:fail invalid file type"===e.errMsg?t.useToast().error("下载格式错误"):t.useToast().error("保存视频失败"),a(`保存视频失败${e.errMsg}`)}})}}[o])()}else 404===s.statusCode?(t.useToast().error("下载资源不存在"),a("下载资源不存在")):(t.useToast().error("下载失败"),a("下载失败"))},fail:e=>{console.error(e),"string"!=typeof e&&(e=JSON.stringify(e)),a(e)},complete:()=>{null==n||n()}})},exports.useGetRequest=function(e,s,o){return u({url:e,...o,data:s,method:"GET"})},exports.useListRequest=function(s,o,r,t){let a=!1;const n=Object.assign({},e.toRaw(o)),i=e.ref([]),l=e.reactive({page:1,page_size:20,pedding:!0,count:0,isCompleted:!1}),c=async e=>{if(l.pedding=!0,e&&(o={...o,...e.newParams}),console.log(i.value.length<l.count),a){if(!(i.value.length<l.count))return l.isCompleted=!0,Promise.resolve({count:l.count,extend:[],lists:i.value,page_no:l.page,page_size:l.page_size});l.page+=1}return new Promise(((e,r)=>{u({...t,url:s,data:{...{page_no:l.page,page_size:l.page_size,...o},params:o}}).then((s=>{a=!0,l.count=s.count,i.value=[...i.value,...s.lists],i.value.length>=l.count&&(l.isCompleted=!0),l.pedding=!1,e(s)})).catch((e=>{l.page-=1,l.pedding=!1,r(e)})).finally((()=>{l.pedding=!1}))}))};return{list:i,state:l,getList:c,refresh:async e=>(l.page=1,l.count=0,i.value=[],await c({newParams:null==e?void 0:e.newParams})),resetParams:(e=!0)=>{l.page=1,l.count=0,i.value=[],o&&(o=n),e&&c()}}},exports.usePostRequest=function(e,s,o){return u({url:e,...o,data:s,method:"POST"})},exports.useUpload=u=>{const{type:n,data:i,success:l,fail:c,complete:d}=u,{file:m,...g}=i,p={image:"/upload/image",video:"/upload/video",file:"/upload/file"}[n];let f;f="string"==typeof m?{filePath:m}:{file:m};const T=r.useUserStore();return e.index.uploadFile({header:{token:T.token,version:s.config.version},url:`${s.config.baseUrl}${s.config.urlPrefix}${p}`,name:"file",...f,formData:g,success:e=>{const s=JSON.parse(e.data),r={[o.RequestCodeEnum.SUCCESS]:()=>{1===s.show&&t.useToast().success(s.msg),l(s.data)},[o.RequestCodeEnum.FAIL]:()=>{1===s.show&&t.useToast(s.msg),c(s.msg)},[o.RequestCodeEnum.LOGIN_FAILURE]:()=>{t.useToast(s.msg),a(),c(s.msg)},[o.RequestCodeEnum.NOT_INSTALL]:()=>{t.useToast().error("系统未安装"),c("系统未安装")},[o.RequestCodeEnum.OPEN_NEW_PAGE]:()=>{t.useToast().error("无法跳转新页面"),c("无法跳转新页面")},[o.RequestCodeEnum.FORBIDDEN]:()=>{t.useToast().error("无访问权限"),c("无访问权限")},[o.RequestCodeEnum.NOT_FOUND]:()=>{t.useToast().error("租户不存在"),c("租户不存在")}}[s.code];r?r():c(s.msg),T.refreshToken()},fail:e=>{console.error(e),t.useToast().error(e.errMsg),c(e.errMsg)},complete:()=>{null==d||d()}})};
